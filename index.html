<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Offer Shifts</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .sidebar { width: 64px; background-color: #0b2246; flex-shrink: 0; }
        .top-nav { background-color: #0b2246; color: white; }
        
        .unassigned-shift-block {
            background: repeating-linear-gradient(45deg, #007bff, #007bff 10px, #0069d9 10px, #0069d9 20px);
            color: white; padding: 6px 8px; border-radius: 4px; font-size: 10px;
            text-align: left; margin-top: 4px; display: none;
        }

        .unassigned-row.active .summary-text { display: none; }
        .unassigned-row.active .unassigned-shift-block { display: block; }

        .nav-icon { font-size: 22px; color: #ffffff; opacity: 0.8; cursor: pointer; }
        .employee-row:nth-child(even) { background-color: #fbfcfd; }
        
        .unassigned-card-bg { background-color: #f4f7ff; }
        .pending-badge { background-color: #ffe8e8; color: #b91c1c; padding: 2px 8px; border-radius: 99px; font-size: 10px; font-weight: bold; }

        .modal-overlay { background: rgba(15, 23, 42, 0.4); backdrop-filter: blur(4px); display: none; position: fixed; inset: 0; z-index: 100; align-items: center; justify-content: center; }
        .modal-content { background: white; width: 1150px; height: 680px; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); border: 1px solid #e2e8f0; }
        
        .auto-assign-modal { width: 650px; height: 550px; border: none; }
        .assign-item { transition: all 0.2s; border-left: 4px solid transparent; }
        .assign-item:hover { transform: translateX(5px); border-left-color: #10b981; }

        .tab-container { background: #f1f5f9; border-radius: 6px; padding: 3px; display: flex; margin-bottom: 0px; }
        .tab-btn { flex: 1; padding: 6px; border-radius: 4px; font-size: 12px; font-weight: 600; text-align: center; cursor: pointer; color: #64748b; transition: 0.2s; }
        .tab-btn.active { background: #5e5ce6; color: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        .custom-checkbox { width: 14px; height: 14px; cursor: pointer; accent-color: #5e5ce6; }

        .employee-tile { border: 1px solid #e2e8f0; background: #ffffff; border-radius: 6px; padding: 4px 6px; transition: all 0.2s; cursor: pointer; display: flex; align-items: center; min-height: 40px; position: relative; }
        .employee-tile:hover { border-color: #5e5ce6; background: #f8fafc; }
        .employee-tile.selected { border-color: #5e5ce6; background-color: #f5f3ff; }

        #global-tooltip {
            position: fixed; z-index: 10000; background-color: #1e293b; color: #fff; padding: 10px; border-radius: 8px; font-size: 10px; pointer-events: none; display: none; width: 180px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.4); border: 1px solid #334155;
        }
        .star-gold { color: #facc15; }

        .day-header { border-bottom: 2px solid #f1f5f9; padding: 6px 4px; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; gap: 6px; cursor: pointer; transition: all 0.2s; border-radius: 8px; }
        .day-header:hover { background-color: #f1f5f9; }
        
        .shift-pill { border: 1.5px solid #e2e8f0; background: white; border-radius: 8px; padding: 4px 6px; cursor: pointer; transition: all 0.15s; margin-bottom: 6px; position: relative; display: flex; flex-direction: column; justify-content: space-between; min-height: 48px; }
        .shift-pill:hover { filter: brightness(0.95); transform: translateY(-1px); }
        .shift-pill.selected { box-shadow: 0 4px 12px rgba(94, 92, 230, 0.2); border-color: #4338ca !important; background-color: #e0e7ff !important; }
        
        .break-icon { font-size: 10px; color: #ef4444; margin-left: 4px; cursor: help; position: relative; }
        .break-tooltip { visibility: hidden; width: 150px; background-color: #334155; color: #fff; text-align: left; padding: 6px 8px; border-radius: 4px; position: absolute; z-index: 60; bottom: 125%; right: 0; opacity: 0; transition: opacity 0.2s; font-size: 9px; line-height: 1.2; box-shadow: 0 4px 6px rgba(0,0,0,0.2); pointer-events: none; }
        .break-icon:hover .break-tooltip { visibility: visible; opacity: 1; }

        .badge { font-size: 8px; font-weight: 800; padding: 1px 4px; border-radius: 4px; text-transform: uppercase; display: block; margin-top: 2px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .main-shift-card { padding: 4px 6px; border-radius: 6px; margin: 2px; border-left: 3px solid; text-align: left; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }

        .list-scroll::-webkit-scrollbar { width: 6px; }
        .list-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        .filter-item { display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid #f1f5f9; }
        .filter-item i { width: 18px; color: #1e40af; text-align: center; }
        .filter-select { background: #fff; border: 1px solid #e2e8f0; border-radius: 4px; font-size: 11px; padding: 2px 6px; outline: none; flex: 1; color: #334155; height: 24px; }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <div id="global-tooltip"></div>

    <div id="offerModal" class="modal-overlay">
        <div class="modal-content">
            <div class="px-6 py-3 border-b flex justify-between items-center bg-white">
                <h2 class="text-lg font-bold text-slate-900">Offer Shifts</h2>
                <button onclick="toggleOfferModal()" class="text-slate-400 hover:text-slate-600 transition-colors"><i class="fa-solid fa-xmark text-lg"></i></button>
            </div>
            
            <div class="flex flex-1 overflow-hidden">
                <div class="flex-1 flex flex-col bg-slate-50 overflow-hidden border-r">
                    <div class="h-[45%] flex flex-col bg-white border-b overflow-hidden">
                        <div class="px-4 py-2 flex justify-between items-center bg-white sticky top-0 z-10">
                            <h3 class="text-[10px] font-bold text-slate-700 uppercase tracking-wider">Unassigned Shifts</h3>
                            <div class="flex items-center space-x-3 bg-slate-50 px-3 py-1 rounded-lg border border-slate-200">
                                <span class="text-[10px] font-bold text-slate-600 uppercase">Select All Shifts</span>
                                <input type="checkbox" id="globalShiftToggle" onchange="toggleAllShiftsGlobal(this)" class="custom-checkbox">
                            </div>
                        </div>
                        <div class="flex-1 overflow-y-auto list-scroll px-4 pb-2">
                            <div class="grid grid-cols-7 gap-2" id="shiftTimeline"></div>
                        </div>
                    </div>

                    <div class="flex-1 flex flex-col bg-white overflow-hidden">
                        <div class="px-4 py-2 border-b flex justify-between items-center bg-slate-50/50">
                            <div class="tab-container w-40">
                                <div id="eligibleTab" class="tab-btn active !py-1" onclick="switchTab('eligible')">Eligible</div>
                                <div id="othersTab" class="tab-btn !py-1" onclick="switchTab('others')">Others</div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-[9px] font-bold text-slate-500">GLOBAL SELECT</span>
                                <input type="checkbox" id="selectAllToggle" onchange="handleSelectAll(this)" class="custom-checkbox">
                            </div>
                        </div>
                        
                        <div class="flex-1 overflow-y-auto list-scroll px-4 py-2 relative">
                            <div class="grid grid-cols-7 gap-2 sticky top-0 bg-white z-20 pb-2 border-b mb-2">
                                <script>
                                    const daysArr = ["SUN 14", "MON 15", "TUE 16", "WED 17", "THU 18", "FRI 19", "SAT 20"];
                                    daysArr.forEach((day, idx) => {
                                        document.write(`
                                            <div class="flex items-center justify-center p-1.5 bg-slate-50 rounded border border-slate-100 gap-2 cursor-pointer" onclick="toggleEmployeeColHeader(${idx})">
                                                <span class="text-[8px] font-bold text-slate-400 uppercase">${day}</span>
                                                <input type="checkbox" id="col-check-${idx}" onchange="toggleEmployeeCol(${idx}, this.checked)" onclick="event.stopPropagation()" class="custom-checkbox">
                                            </div>
                                        `);
                                    });
                                </script>
                            </div>
                            <div id="popupEmployeeContainer" class="grid grid-cols-7 gap-2 align-start content-start overflow-x-hidden"></div>
                        </div>
                    </div>
                </div>

                <div class="w-[280px] bg-white p-4 flex flex-col">
                    <div class="flex-1 space-y-2">
                        <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest border-b pb-2 mb-2">Filters</h3>
                        <div class="filter-item">
                            <i class="fa-solid fa-building text-[12px]"></i>
                            <span class="text-[11px] text-slate-600 w-20">Dept:</span>
                            <select id="filterDept" onchange="applyFilters()" class="filter-select">
                                <option value="all">Any Dept</option>
                                <option value="FOH">FOH</option>
                                <option value="BOH">BOH</option>
                                <option value="Maintenance">Maintenance</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <i class="fa-solid fa-briefcase text-[12px]"></i>
                            <span class="text-[11px] text-slate-600 w-20">Position:</span>
                            <select id="filterPos" onchange="applyFilters()" class="filter-select">
                                <option value="all">Any Position</option>
                                <option value="Assistant Manager">Assistant Manager</option>
                                <option value="Cashier">Cashier</option>
                                <option value="Floor Supervisor">Floor Supervisor</option>
                                <option value="Manager">Manager</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <i class="fa-solid fa-circle-right text-[12px] text-emerald-500"></i>
                            <span class="text-[11px] text-slate-600 w-20">Pay Rate:</span>
                            <select id="sortPay" onchange="applyFilters()" class="filter-select">
                                <option value="all">Default</option>
                                <option value="lowest">Sort: Lowest</option>
                                <option value="highest">Sort: Highest</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <i class="fa-solid fa-circle-check text-[12px] text-blue-600"></i>
                            <span class="text-[11px] text-slate-600 w-20">Hours:</span>
                            <select id="sortHours" onchange="applyFilters()" class="filter-select">
                                <option value="all">Default</option>
                                <option value="asc">Ascending</option>
                                <option value="desc">Descending</option>
                            </select>
                        </div>
                        <div class="pt-4 pb-6">
                            <label class="block text-[9px] font-bold text-slate-500 uppercase mb-1">Max Pay Rate ($)</label>
                            <div class="relative">
                                <span class="absolute left-2.5 top-1.5 text-slate-400 text-[11px]">$</span>
                                <input type="number" id="filterPay" oninput="applyFilters()" placeholder="0.00" class="w-full border rounded-md p-1.5 pl-5 text-[11px] bg-slate-50">
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-col space-y-3 pt-4 border-t">
                        <button onclick="handleAutoAssignInit()" class="w-full bg-emerald-600 text-white py-3 rounded-md font-bold text-[11px] flex items-center justify-center transition-all hover:bg-emerald-700 shadow-md">
                            <i class="fa-solid fa-wand-magic-sparkles mr-2"></i> Auto Assign
                        </button>
                        <button id="sendOfferBtn" class="w-full bg-[#5e5ce6] text-white py-3 rounded-md font-bold text-[11px] flex items-center justify-center transition-all hover:bg-indigo-700 shadow-md">
                            <i class="fa-regular fa-paper-plane mr-2"></i> Send Offer
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="autoAssignModal" class="modal-overlay">
        <div class="modal-content auto-assign-modal">
            <div class="px-6 py-4 border-b bg-[#5e5ce6] text-white flex justify-between items-center">
                <div>
                    <h2 class="text-lg font-bold">Auto Assign</h2>
                    <p class="text-[10px] opacity-90 font-medium">Confirm generated assignments</p>
                </div>
                <button onclick="closeAutoAssign()" class="hover:bg-white/20 p-2 rounded-full transition-colors"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-4 overflow-y-auto list-scroll flex-1 bg-slate-50" id="autoAssignList"></div>
            <div class="p-4 border-t bg-white flex space-x-3">
                <button onclick="closeAutoAssign()" class="flex-1 py-3 border border-slate-200 rounded-lg text-xs font-bold text-slate-500 hover:bg-slate-50 transition-colors">Discard</button>
                <button onclick="finalizeAssignments()" class="flex-1 py-3 bg-emerald-600 text-white rounded-lg text-xs font-bold hover:bg-emerald-700 shadow-lg transition-all">Confirm Assignments</button>
            </div>
        </div>
    </div>

    <aside class="sidebar flex flex-col items-center py-6 space-y-8">
        <i class="fa-regular fa-calendar-check nav-icon text-white"></i>
        <i class="fa-regular fa-circle-user nav-icon"></i>
        <i class="fa-regular fa-clock nav-icon"></i>
        <i class="fa-regular fa-user-group nav-icon"></i>
        <i class="fa-regular fa-chart-bar nav-icon"></i>
        <i class="fa-regular fa-file-lines nav-icon"></i>
        <i class="fa-regular fa-address-book nav-icon"></i>
    </aside>

    <main class="flex-1 flex flex-col overflow-hidden">
        <header class="top-nav h-14 flex items-center justify-between px-4 flex-shrink-0">
            <div class="flex items-center space-x-8 text-sm">
                <div class="flex items-center font-medium opacity-90">My Apps <i class="fa-solid fa-caret-down ml-1 text-[10px]"></i></div>
                <div class="flex items-center font-medium opacity-90">Dashboard</div>
                <div class="flex items-center text-blue-300 border-b-2 border-blue-300 pb-1 font-semibold">Schedule</div>
            </div>
            <div class="bg-white text-gray-800 px-4 py-1.5 rounded-full text-xs font-bold shadow-sm">
                Corporate Head <i class="fa-solid fa-caret-down ml-2 text-[10px]"></i>
            </div>
        </header>

        <div class="bg-white border-b flex items-center justify-between px-4 py-2 flex-shrink-0">
            <div class="flex items-center space-x-2">
                <div class="flex border rounded text-xs bg-white overflow-hidden shadow-sm">
                    <button class="px-2 py-1 border-r"><i class="fa-solid fa-chevron-left text-[10px]"></i></button>
                    <button class="px-4 py-1 font-semibold">12/16/2025 <i class="fa-solid fa-caret-down ml-1 text-gray-400"></i></button>
                    <button class="px-2 py-1 border-l"><i class="fa-solid fa-chevron-right text-[10px]"></i></button>
                </div>
            </div>
            <div class="flex items-center space-x-3">
                <button class="bg-blue-600 text-white px-4 py-1.5 rounded text-xs font-bold shadow-sm">+ Add Employee</button>
            </div>
        </div>

        <div class="flex-1 overflow-auto bg-white relative">
            <table class="w-full table-fixed border-collapse">
                <thead class="sticky top-0 z-20 bg-gray-50 text-[10px] uppercase text-gray-500 font-bold">
                    <tr>
                        <th class="w-64 p-3 text-left border-b border-r bg-white">Employees</th>
                        <th class="border-b border-r p-2 text-center">Sun 14</th>
                        <th class="border-b border-r p-2 text-center">Mon 15</th>
                        <th class="border-b border-r p-2 text-center">Tue 16</th>
                        <th class="border-b border-r p-2 text-center bg-blue-50/30">Wed 17</th>
                        <th class="border-b border-r p-2 text-center">Thu 18</th>
                        <th class="border-b border-r p-2 text-center">Fri 19</th>
                        <th class="border-b p-2 text-center">Sat 20</th>
                    </tr>
                </thead>
                <tbody id="employee-rows"></tbody>
            </table>
        </div>
    </main>

    <script>
        const firstNames = ["Michael", "Sarah", "James", "Emily", "Robert", "Jennifer", "John", "Jessica", "David", "Linda", "William", "Elizabeth", "Thomas", "Susan", "Joseph", "Margaret", "Richard", "Ashley", "Christopher", "Kimberly"];
        const lastNames = ["Smith", "Johnson", "Williams", "Brown", "Jones", "Garcia", "Miller", "Davis", "Rodriguez", "Martinez"];

        const allEmployees = [];
        for(let i=0; i<48; i++) {
            const fname = firstNames[Math.floor(Math.random()*firstNames.length)];
            const lname = lastNames[Math.floor(Math.random()*lastNames.length)];
            const name = fname + " " + lname;
            const skillMap = {
                "Manager": Math.floor(Math.random()*2)+4, "Assistant Manager": Math.floor(Math.random()*3)+3, "Cashier": Math.floor(Math.random()*3)+2, "Floor Supervisor": Math.floor(Math.random()*3)+3
            };
            allEmployees.push({
                name: name, initial: fname[0] + lname[0], color: ["bg-blue-600", "bg-orange-500", "bg-pink-600", "bg-amber-600", "bg-red-600", "bg-indigo-600", "bg-emerald-600", "bg-violet-600"][i % 8],
                rate: (Math.random() * 15 + 10).toFixed(2), hours: Math.floor(Math.random() * 30 + 10), minHours: Math.floor(Math.random() * 10 + 5) + "h",
                eligible: i < 24, dept: i % 3 === 0 ? "FOH" : (i % 3 === 1 ? "BOH" : "Maintenance"),
                pos: i % 4 === 0 ? "Manager" : (i % 4 === 1 ? "Assistant Manager" : (i % 4 === 2 ? "Cashier" : "Floor Supervisor")),
                skills: skillMap, shifts: {}
            });
        }

        const roleOptions = ["Manager", "Assistant Manager", "Cashier", "Floor Supervisor"];
        const shiftTimes = ["8:00A - 4:00P", "4:00P - 9:00P", "6:00A - 2:00P"];
        const roleColors = {
            "Manager": { border: "#4f46e5", bg: "#e0e7ff", text: "#4338ca" },
            "Assistant Manager": { border: "#9333ea", bg: "#f3e8ff", text: "#7e22ce" },
            "Cashier": { border: "#16a34a", bg: "#dcfce7", text: "#15803d" },
            "Floor Supervisor": { border: "#ea580c", bg: "#ffedd5", text: "#9a3412" }
        };

        let currentTab = 'eligible';
        let globalUnassignedShifts = [];
        let pendingAssignments = [];
        let unassignedVisible = false; 

        function toggleOfferModal() {
            const modal = document.getElementById('offerModal');
            modal.style.display = (modal.style.display === 'flex') ? 'none' : 'flex';
            if (modal.style.display === 'flex') {
                if(globalUnassignedShifts.length === 0) initGlobalShifts();
                applyFilters();
            }
        }

        function initGlobalShifts() {
            for(let d=0; d<7; d++) {
                const shuffled = [...roleOptions].sort(() => 0.5 - Math.random());
                for(let i=0; i<3; i++) {
                    const r = shuffled[i];
                    globalUnassignedShifts.push({ id: `s-${d}-${i}`, dayIdx: d, dayName: daysArr[d], time: shiftTimes[i], pos: r, dept: (r === "Cashier" || r === "Floor Supervisor") ? "BOH" : "FOH" });
                }
            }
        }

        function switchTab(tab) {
            currentTab = tab;
            document.getElementById('eligibleTab').classList.toggle('active', tab === 'eligible');
            document.getElementById('othersTab').classList.toggle('active', tab === 'others');
            applyFilters();
        }

        // Updated Filter Logic: Shifts filter by Position only. Employees filter by Department AND Position.
        function applyFilters() {
            const dept = document.getElementById('filterDept').value;
            const pos = document.getElementById('filterPos').value;
            const maxPay = parseFloat(document.getElementById('filterPay').value) || Infinity;
            const paySort = document.getElementById('sortPay').value;
            const hourSort = document.getElementById('sortHours').value;

            // 1. Filter Employees (uses both Dept and Position)
            let filteredEmps = allEmployees.filter(e => 
                (currentTab === 'eligible' ? e.eligible : !e.eligible) && 
                (dept === 'all' || e.dept === dept) && 
                (pos === 'all' || e.pos === pos) && 
                (parseFloat(e.rate) <= maxPay)
            );
            
            if (paySort === 'lowest') filteredEmps.sort((a, b) => a.rate - b.rate);
            else if (paySort === 'highest') filteredEmps.sort((a, b) => b.rate - a.rate);
            if (hourSort === 'asc') filteredEmps.sort((a, b) => a.hours - b.hours);
            else if (hourSort === 'desc') filteredEmps.sort((a, b) => b.hours - a.hours);

            renderPopupEmployees(filteredEmps);

            // 2. Filter Shifts (USES POSITION ONLY as requested)
            let filteredShifts = globalUnassignedShifts.filter(s => 
                (pos === 'all' || s.pos === pos)
            );
            renderShifts(filteredShifts);

            updateButtonText();
        }

        function renderPopupEmployees(list) {
            const container = document.getElementById('popupEmployeeContainer');
            container.innerHTML = "";
            for(let i=0; i<7; i++) {
                const col = document.createElement('div');
                col.className = "flex flex-col space-y-2 employee-col-" + i;
                const colEmployees = list.filter((_, idx) => idx % 7 === i);
                col.innerHTML = colEmployees.map(emp => {
                    const skillHtml = Object.entries(emp.skills).map(([p, s]) => {
                        let stars = '';
                        for(let x=1; x<=5; x++) stars += `<i class="fa-solid fa-star ${x <= s ? 'star-gold' : 'text-slate-600'}"></i>`;
                        return `<div class="flex justify-between items-center mb-0.5"><span>${p}</span><span class="ml-2">${stars}</span></div>`;
                    }).join('');
                    const tooltipContent = `<div class="font-bold border-b border-slate-600 mb-2 pb-1 text-blue-400">${emp.name}</div><div class="mb-1 flex justify-between"><span>Pay Rate:</span><span class="font-bold text-emerald-400">$${emp.rate}/hr</span></div><div class="mb-1 flex justify-between"><span>Min Hours:</span><span class="font-bold">${emp.minHours}</span></div><div class="mb-2 flex justify-between"><span>Worked:</span><span class="font-bold">${emp.hours}h</span></div><div class="text-[9px] font-bold text-slate-400 uppercase mb-1">Positions & Skills</div>${skillHtml}`;
                    return `<div class="employee-tile flex items-center shadow-sm" onclick="toggleTile(this)" onmouseenter="showTooltip(event, '${encodeURIComponent(tooltipContent)}')" onmouseleave="hideTooltip()">
                        <div class="w-6 h-6 rounded-md ${emp.color} text-white flex-shrink-0 flex items-center justify-center font-bold text-[8px] shadow-sm">${emp.initial}</div>
                        <div class="flex-1 min-w-0 ml-1.5 flex justify-between items-center">
                            <span class="font-bold text-slate-800 text-[10px] truncate pr-1">${emp.name}</span>
                            <input type="checkbox" class="custom-checkbox pointer-events-none" onclick="event.stopPropagation(); updateButtonText()">
                        </div>
                    </div>`;
                }).join('');
                container.appendChild(col);
            }
        }

        function showTooltip(e, content) {
            const tooltip = document.getElementById('global-tooltip');
            tooltip.innerHTML = decodeURIComponent(content);
            tooltip.style.display = 'block';
            const rect = e.currentTarget.getBoundingClientRect();
            let top = rect.top - tooltip.offsetHeight - 10;
            let left = rect.left + (rect.width / 2) - (tooltip.offsetWidth / 2);
            if (top < 0) top = rect.bottom + 10;
            if (left < 10) left = 10;
            if (left + tooltip.offsetWidth > window.innerWidth) left = window.innerWidth - tooltip.offsetWidth - 10;
            tooltip.style.top = top + 'px'; tooltip.style.left = left + 'px';
        }
        function hideTooltip() { document.getElementById('global-tooltip').style.display = 'none'; }
        
        function toggleTile(tile) {
            const cb = tile.querySelector('input');
            cb.checked = !cb.checked;
            tile.classList.toggle('selected', cb.checked);
            updateButtonText();
        }

        function updateButtonText() {
            const count = document.querySelectorAll('#popupEmployeeContainer .employee-tile input:checked').length;
            document.getElementById('sendOfferBtn').innerHTML = `<i class="fa-regular fa-paper-plane mr-2"></i> Send Offer ${count > 0 ? '(' + count + ')' : ''}`;
        }

        function toggleEmployeeColHeader(idx) {
            const chk = document.getElementById(`col-check-${idx}`);
            chk.checked = !chk.checked;
            toggleEmployeeCol(idx, chk.checked);
        }

        function toggleEmployeeCol(colIdx, isChecked) {
            const col = document.querySelector(`.employee-col-${colIdx}`);
            if(!col) return;
            col.querySelectorAll('.employee-tile').forEach(tile => {
                const cb = tile.querySelector('input');
                cb.checked = isChecked;
                tile.classList.toggle('selected', isChecked);
            });
            updateButtonText();
        }

        function handleSelectAll(source) {
            document.querySelectorAll('.employee-tile').forEach(t => {
                const cb = t.querySelector('input');
                cb.checked = source.checked;
                t.classList.toggle('selected', source.checked);
            });
            for(let i=0; i<7; i++) {
                const colChk = document.getElementById(`col-check-${i}`);
                if(colChk) colChk.checked = source.checked;
            }
            updateButtonText();
        }

        function getBreakDetails(timeStr) {
            if(timeStr.includes("8:00A")) return `Meal: 11:30A - 12:00P<br>Rest: 2:00P - 2:15P`;
            if(timeStr.includes("4:00P")) return `Meal: 6:30P - 7:00P`;
            if(timeStr.includes("6:00A")) return `Meal: 10:00A - 10:30A<br>Rest: 12:30P - 12:45P`;
            return "No breaks scheduled";
        }

        function renderShifts(shiftList = globalUnassignedShifts) {
            const grid = document.getElementById('shiftTimeline');
            grid.innerHTML = "";
            daysArr.forEach((day, dIdx) => {
                const dayShifts = shiftList.filter(s => s.dayIdx === dIdx);
                let shiftItems = dayShifts.map(s => {
                    const colors = roleColors[s.pos] || { border: "#ccc", bg: "#eee", text: "#333" };
                    const breaks = getBreakDetails(s.time);
                    return `<div class="shift-pill" id="${s.id}" style="border-color: ${colors.border}; color: ${colors.border}" data-dept="${s.dept}" data-pos="${s.pos}" data-time="${s.time}" data-day="${dIdx}" data-dayname="${day}" onclick="toggleSingleShift(this)">
                            <div class="flex justify-between items-start">
                                <div class="text-[9px] font-bold text-slate-700 leading-tight">${s.time}</div>
                                <div class="break-icon"><i class="fa-solid fa-mug-hot"></i><div class="break-tooltip"><strong>Breaks:</strong><br>${breaks}</div></div>
                            </div>
                            <span class="badge" style="background-color: ${colors.bg}; color: ${colors.text}">${s.pos}</span>
                        </div>`;
                }).join('');
                
                grid.innerHTML += `<div class="flex flex-col" id="day-col-${dIdx}">
                    <div class="day-header" onclick="toggleDayUIHeader(${dIdx})">
                        <span class="text-[9px] font-extrabold text-slate-500 uppercase tracking-wider">${day}</span>
                        <input type="checkbox" id="day-toggle-${dIdx}" onchange="toggleDayUI(${dIdx}, this.checked)" onclick="event.stopPropagation()" class="custom-checkbox">
                    </div>${shiftItems}</div>`;
            });
        }

        function toggleSingleShift(pill) { pill.classList.toggle('selected'); }
        function toggleDayUIHeader(idx) {
            const chk = document.getElementById(`day-toggle-${idx}`);
            chk.checked = !chk.checked;
            toggleDayUI(idx, chk.checked);
        }
        function toggleDayUI(idx, isChecked) {
            const pills = document.getElementById(`day-col-${idx}`).querySelectorAll('.shift-pill');
            pills.forEach(p => isChecked ? p.classList.add('selected') : p.classList.remove('selected'));
        }
        function toggleAllShiftsGlobal(source) {
            document.querySelectorAll('.shift-pill').forEach(p => source.checked ? p.classList.add('selected') : p.classList.remove('selected'));
            for(let i=0; i<7; i++) { 
                const dChk = document.getElementById(`day-toggle-${i}`);
                if(dChk) dChk.checked = source.checked; 
            }
        }

        function handleAutoAssignInit() {
            const selectedShifts = document.querySelectorAll('.shift-pill.selected');
            if (selectedShifts.length === 0) return alert("Please select unassigned shifts first.");
            document.getElementById('offerModal').style.display = 'none';
            const candidates = allEmployees.filter(e => currentTab === 'eligible' ? e.eligible : !e.eligible);
            pendingAssignments = [];
            selectedShifts.forEach((pill, index) => {
                const assignedEmp = candidates[index % candidates.length];
                pendingAssignments.push({ 
                    shiftId: pill.id, day: pill.dataset.dayname, dayIdx: pill.dataset.day, 
                    time: pill.dataset.time, pos: pill.dataset.pos, empName: assignedEmp.name 
                });
            });
            renderAutoAssignModal(candidates);
            document.getElementById('autoAssignModal').style.display = 'flex';
        }

        function renderAutoAssignModal(candidates) {
            document.getElementById('autoAssignList').innerHTML = pendingAssignments.map((item, idx) => {
                const getStars = (emp) => {
                    const level = emp.skills[item.pos] || 0;
                    let stars = '';
                    for(let i=0; i<5; i++) stars += i < level ? '⭐' : '☆'; 
                    return stars;
                };
                return `<div class="assign-item bg-white p-4 rounded-xl shadow-sm mb-3 flex items-center justify-between border border-slate-100">
                    <div>
                        <div class="flex items-center space-x-2 mb-1">
                            <span class="text-[9px] font-black bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded-full uppercase">${item.day}</span>
                            <span class="text-xs font-bold text-slate-800">${item.time}</span>
                        </div>
                        <div class="text-[10px] text-slate-400 font-bold uppercase">${item.pos}</div>
                    </div>
                    <select onchange="pendingAssignments[${idx}].empName = this.value" class="bg-slate-50 border-none rounded-lg px-3 py-2 text-xs font-bold text-slate-700 w-64">
                        ${candidates.map(c => `<option value="${c.name}" ${c.name === item.empName ? 'selected' : ''}>${c.name} (${getStars(c)})</option>`).join('')}
                    </select>
                </div>`;
            }).join('');
        }

        function closeAutoAssign() { document.getElementById('autoAssignModal').style.display = 'none'; }
        
        function finalizeAssignments() {
            pendingAssignments.forEach(item => {
                const emp = allEmployees.find(e => e.name === item.empName);
                if (emp) {
                    emp.shifts[item.dayIdx] = item.time.replace(/\s/g, '');
                    emp.pos = item.pos; 
                }
                globalUnassignedShifts = globalUnassignedShifts.filter(s => s.id !== item.shiftId);
            });
            refreshMainSchedule(); closeAutoAssign();
        }

        function toggleUnassignedRow() {
            unassignedVisible = !unassignedVisible;
            refreshMainSchedule();
        }

        function refreshMainSchedule() {
            const tbody = document.getElementById('employee-rows');
            tbody.innerHTML = '';
            const pendingCount = globalUnassignedShifts.length;
            
            let unassignedRowHtml = `<tr id="unassigned-row" class="unassigned-row ${unassignedVisible ? 'active' : ''}">
                <td class="p-4 border-r border-b sticky left-0 unassigned-card-bg shadow-sm z-20">
                    <div class="flex flex-col items-center">
                        <div class="flex items-center space-x-2 mb-3">
                            <span class="text-gray-800 font-bold text-[14px]">Unassigned</span>
                            <span class="pending-badge">${pendingCount} Pending</span>
                        </div>
                        <div class="flex space-x-2 w-full justify-center">
                            <button onclick="toggleUnassignedRow()" class="bg-white border border-blue-100 text-blue-600 px-3 py-1.5 rounded-lg text-[11px] font-bold w-24 flex items-center justify-center gap-1.5 transition-all hover:bg-blue-50">
                                <i class="fa-solid ${unassignedVisible ? 'fa-eye-slash' : 'fa-eye'}"></i>
                                ${unassignedVisible ? 'Hide' : 'Show'}
                            </button>
                            <button onclick="toggleOfferModal()" class="bg-[#5e5ce6] text-white px-3 py-1.5 rounded-lg text-[11px] font-bold w-24 flex items-center justify-center gap-1.5 transition-all hover:bg-indigo-700">
                                Offer Shifts
                            </button>
                        </div>
                    </div>
                </td>`;

            for(let i=0; i<7; i++) {
                const dayShifts = globalUnassignedShifts.filter(s => s.dayIdx === i);
                let dayShiftsHtml = dayShifts.map(s => {
                    const c = roleColors[s.pos] || { border: "#ccc", bg: "#eee", text: "#333" };
                    return `<div class="unassigned-shift-block">
                        <div class="font-extrabold">${s.time}</div>
                        <div class="opacity-90 font-bold uppercase" style="font-size: 8px;">${s.pos}</div>
                    </div>`;
                }).join('');

                unassignedRowHtml += `<td class="border-r border-b text-center p-2">
                    <div class="summary-text text-[11px] font-bold text-gray-600">${dayShifts.length} Shift(s)</div>
                    <div class="unassigned-container">${dayShiftsHtml}</div>
                </td>`;
            }
            unassignedRowHtml += `</tr>`;
            tbody.insertAdjacentHTML('beforeend', unassignedRowHtml);

            allEmployees.forEach(emp => {
                const tr = document.createElement('tr');
                tr.className = "employee-row h-14 border-b text-xs";
                let rowHtml = `<td class="p-2 border-r flex items-center space-x-3 sticky left-0 bg-white z-10 shadow-sm"><div class="w-8 h-8 rounded-full ${emp.color} text-white flex items-center justify-center font-bold text-[10px]">${emp.initial}</div><div class="font-bold text-slate-700">${emp.name}</div></td>`;
                for(let i=0; i<7; i++) {
                    let content = "";
                    if (emp.shifts[i]) {
                        const c = roleColors[emp.pos] || { border: "#ccc", bg: "#eee", text: "#333" };
                        content = `<div class="main-shift-card" style="border-left-color: ${c.border}; background-color: ${c.bg}; color: ${c.text}"><div class="font-extrabold text-[9px]">${emp.shifts[i]}</div><div class="opacity-80 text-[8px] font-bold uppercase truncate">${emp.pos}</div></div>`;
                    }
                    rowHtml += `<td class="border-r border-b p-1">${content}</td>`;
                }
                tr.innerHTML = rowHtml; tbody.appendChild(tr);
            });
        }

        initGlobalShifts(); 
        refreshMainSchedule();
    </script>
</body>
</html>
